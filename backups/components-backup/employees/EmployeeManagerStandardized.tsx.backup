import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { employeesApi, Employee as ApiEmployee } from "@/core/api";
import { EmployeeList } from "./EmployeeList";
import { EmployeeHeader } from "./EmployeeHeader";
import { EmployeeDialogStandardized } from "./EmployeeDialogStandardized";
import { useToast } from "@/hooks";
import { useEmployeeDialog } from "@/hooks/useEmployeeDialog";
import { Employee } from "@/types";
import { adaptApiEmployeesToAppEmployees } from "@/core/api/adapters/employeeAdapter";

export function EmployeeManagerStandardized() {
  // Hooks
  const queryClient = useQueryClient();
  const { toast } = useToast();
  const employeeDialog = useEmployeeDialog({
    onCreateSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["employees"] });
      toast({
        title: "Success",
        description: "Employee created successfully",
      });
    },
    onUpdateSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["employees"] });
      toast({
        title: "Success",
        description: "Employee updated successfully",
      });
    },
  });

  // Data fetching with type adapter
  const { data: employees, isLoading } = useQuery({
    queryKey: ["employees"],
    queryFn: async () => {
      const response = await employeesApi.getEmployees();
      // Use adapter to convert API response to application type
      return adaptApiEmployeesToAppEmployees(response.data || []);
    },
  });

  // Mutations with type adapter
  const deleteMutation = useMutation({
    mutationFn: (id: string) => employeesApi.deleteEmployee(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["employees"] });
      toast({
        title: "Success",
        description: "Employee deleted successfully",
      });
    },
    onError: (error) => {
      toast({
        title: "Error",
        description: "Failed to delete employee",
        variant: "destructive",
      });
    },
  });

  // Event handlers
  const handleDelete = async (id: string) => {
    await deleteMutation.mutateAsync(id);
  };

  return (
    <div className="space-y-6">
      <EmployeeHeader onAdd={employeeDialog.openCreate} />
      <EmployeeList
        employees={employees || []}
        isLoading={isLoading}
        onEdit={employeeDialog.openEdit}
        onDelete={handleDelete}
      />
      <EmployeeDialogStandardized
        open={employeeDialog.isOpen}
        onOpenChange={employeeDialog.onOpenChange}
        employee={employeeDialog.selectedEmployee}
        onSubmit={employeeDialog.handleSubmit}
      />
    </div>
  );
} 